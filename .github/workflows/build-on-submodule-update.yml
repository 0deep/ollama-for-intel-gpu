name: Build on Submodule Update

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - main
      - develop
    # Only trigger for submodule-related PRs
    paths:
      - 'ollama'
      - '.gitmodules'

jobs:
  build-with-updated-submodule:
    # Only run on auto-generated PRs
    if: contains(github.event.pull_request.labels.*.name, 'submodule-update')
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      pull-requests: write
      
    steps:
      - name: Checkout PR
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          submodules: recursive
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        
      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository }}
          tags: |
            type=ref,event=pr
            type=sha,prefix=submodule-update-
      
      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: false
          load: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: Test Docker image
        id: test
        continue-on-error: true
        run: |
          IMAGE_TAG=$(echo "${{ steps.meta.outputs.tags }}" | head -n1)
          echo "Testing image: $IMAGE_TAG"
          
          # Basic execution test
          docker run --rm $IMAGE_TAG --version > /tmp/version.txt 2>&1 || true
          
          if [ -s /tmp/version.txt ]; then
            echo "âœ… Image test passed"
            echo "result=success" >> $GITHUB_OUTPUT
            cat /tmp/version.txt
          else
            echo "âš ï¸ Image test failed or no output"
            echo "result=warning" >> $GITHUB_OUTPUT
          fi
      
      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const testResult = '${{ steps.test.outputs.result }}';
            const icon = testResult === 'success' ? 'âœ…' : 'âš ï¸';
            const status = testResult === 'success' ? 'Build Successful' : 'Build Completed with Warnings';
            
            const comment = `## ${icon} Submodule Update Build Report
            
            **Status:** ${status}
            **Commit:** \`${{ github.event.pull_request.head.sha }}\`
            **Docker Image Tags:**
            \`\`\`
            ${{ steps.meta.outputs.tags }}
            \`\`\`
            
            ### Build Details
            - Build completed at: ${new Date().toISOString()}
            - Workflow run: [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            
            ${testResult === 'success' ? 'âœ… All tests passed. Safe to merge.' : 'âš ï¸ Please review the build logs before merging.'}
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
      
      - name: Push Docker image (optional)
        if: steps.test.outputs.result == 'success'
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
      
      - name: Generate summary
        if: always()
        run: |
          echo "## ðŸ”¨ Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**PR:** #${{ github.event.pull_request.number }}" >> $GITHUB_STEP_SUMMARY
          echo "**Title:** ${{ github.event.pull_request.title }}" >> $GITHUB_STEP_SUMMARY
          echo "**Test Result:** ${{ steps.test.outputs.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Docker Tags" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.meta.outputs.tags }}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
